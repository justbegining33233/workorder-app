<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Socket Debug</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px} #log{white-space:pre-wrap;background:#111;color:#e6e6e6;padding:12px;border-radius:6px;min-height:200px} button{margin:8px 0;padding:8px 12px}</style>
</head>
<body>
  <h1>Socket Debug</h1>
  <p>This page will attempt to connect to the socket server using the JWT stored in localStorage under "token".</p>
  <div>
    <label>Token in localStorage? <span id="hasToken">?</span></label>
  </div>
  <div style="margin-top:10px">
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button>
    <button id="loginTest">Login as cust1 & connect</button>
  </div>
  <h3>Logs</h3>
  <div id="log">Idle...</div>

  <script>
    (function(){
      function addScript(src, onload, onerror) {
        const s = document.createElement('script');
        s.src = src;
        s.onload = onload;
        s.onerror = onerror;
        document.head.appendChild(s);
      }

      // Try CDN first (no integrity attribute) then fallback to in-app path
      addScript('https://cdn.socket.io/4.8.3/socket.io.min.js', () => {
        console.log('Loaded socket.io from CDN');
      }, () => {
        console.warn('CDN failed, trying in-app /socket.io/socket.io.js');
        addScript('/socket.io/socket.io.js', () => {
          console.log('Loaded socket.io from in-app path');
        }, () => {
          console.error('Failed to load socket.io from both CDN and in-app path');
        });
      });
    })();
  </script>
  <script>
    const logEl = document.getElementById('log');
    const hasTokenEl = document.getElementById('hasToken');
    const connectBtn = document.getElementById('connect');
    const disconnectBtn = document.getElementById('disconnect');
    const loginTestBtn = document.getElementById('loginTest');
    let socket = null;

    function write(...args) {
      const msg = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
      logEl.textContent = (new Date()).toISOString() + ' - ' + msg + '\n' + logEl.textContent;
      console.log(...args);
    }

    function getToken() {
      return localStorage.getItem('token') || null;
    }

    function setTokenStatus() {
      hasTokenEl.textContent = !!getToken();
    }

    setTokenStatus();

    connectBtn.onclick = () => {
      const token = getToken();
      if (!token) { write('No token found in localStorage (key: token). Please login first.'); return; }
      write('Attempting socket connection with token length', token.length);

      // Try to connect to same-origin path first
      try {
        socket = io(window.location.origin, { path: '/api/socket', auth: { token }, transports: ['websocket','polling'], timeout: 10000 });
      } catch (e) {
        write('io init error', e.message || e);
      }

      if (!socket) { write('Socket not initialized'); return; }

      socket.on('connect', () => write('connect', socket.id));
      socket.on('connect_error', (err) => write('connect_error', err && err.message));
      socket.on('disconnect', (reason) => write('disconnect', reason));
      socket.on('work-order-updated', (data) => write('work-order-updated', data));
      socket.on('new-message', (data) => write('new-message', data));

      // Also log engine packets if available
      write('Socket created, waiting for events...');
    };

    disconnectBtn.onclick = () => {
      if (!socket) { write('No socket to disconnect'); return; }
      socket.disconnect();
      write('Manual disconnect called');
      socket = null;
    };

    loginTestBtn.onclick = async () => {
      try {
        write('Logging in as cust1...');
        const res = await fetch('/api/auth/customer', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email: 'cust1', password: 'password' }) });
        const data = await res.json();
        write('Login status', res.status, data);
        const token = data.accessToken || data.token;
        if (!token) { write('No token in response'); return; }
        localStorage.setItem('token', token);
        setTokenStatus();
        write('Stored token, now connecting...');
        connectBtn.onclick();
      } catch (e) {
        write('Login test error', e.message || e);
      }
    };

    // Show connection status in console and UI periodically
    setInterval(setTokenStatus, 2000);
  </script>
</body>
</html>