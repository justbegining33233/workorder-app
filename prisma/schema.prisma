// Prisma Schema for Multi-Tenant Work Order Management System
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Customer model
// IMPORTANT: Do NOT commit connection strings or secrets into the repo.
// Keep the real connection string in a local `.env` file and in your
// deployment platform's env settings (Vercel/Neon). Set `DATABASE_URL` in
// your local `.env` (do not commit the file with real credentials).
model Customer {
  id               String   @id @default(cuid())
  email            String   @unique
  username         String?  @unique
  password         String
  firstName        String
  lastName         String
  phone            String?
  company          String?
  stripeCustomerId String?  @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workOrders     WorkOrder[]
  notifications  Notification[]
  vehicles       Vehicle[]
  paymentMethods PaymentMethod[]
  reviews        Review[]
  appointments   Appointment[]
  favoriteShops  FavoriteShop[]
  documents      CustomerDocument[]
  messages       CustomerMessage[]

  @@map("customers")
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  type      String
  tokenHash String   @unique
  expiresAt DateTime
  metadata  String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("verification_tokens")
}

// Shop model
model Shop {
  id        String  @id @default(cuid())
  username  String  @unique
  password  String
  shopName  String
  ownerName String? // Owner's full name
  email     String
  phone     String
  zipCode   String
  address   String?
  city      String?
  state     String?

  businessLicense String?
  insurancePolicy String?
  shopType        String? // diesel, gas, both
  profileComplete Boolean @default(false)

  // Scheduling capacity
  capacity        Int     @default(1) // Number of bays/simultaneous appointments
  slotDuration    Int     @default(30) // Default time slot duration in minutes

  status String @default("pending") // pending, approved, suspended

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?

  services       ShopService[]
  shopLaborRates ShopLaborRate[]
  workOrders     WorkOrder[]
  techs          Tech[]
  inventory      InventoryItem[]
  settings       ShopSettings?
  reviews        Review[]
  appointments   Appointment[]
  subscription   Subscription?
  schedules      ShopSchedule[]
  blockedDates   ShopBlockedDate[]
  purchaseOrders PurchaseOrder[]

  @@map("shops")
}

// Shop Business Hours (per day of week)
model ShopSchedule {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  dayOfWeek Int      // 0=Sunday, 1=Monday, ... 6=Saturday
  isOpen    Boolean  @default(true)
  openTime  String   // "09:00" format (24hr)
  closeTime String   // "17:00" format (24hr)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shopId, dayOfWeek])
  @@index([shopId])
  @@map("shop_schedules")
}

// Shop Blocked Dates (vacations, holidays, closures)
model ShopBlockedDate {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  date   DateTime // The blocked date
  reason String?  // "Holiday", "Vacation", "Maintenance", etc.

  createdAt DateTime @default(now())

  @@unique([shopId, date])
  @@index([shopId])
  @@index([date])
  @@map("shop_blocked_dates")
}

// Shop Services (51 services)
model ShopService {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  serviceName String
  category    String // diesel, gas
  price       Float? // optional price for the service
  duration    Int? // labor time in minutes
  description String? // notes about the service

  createdAt DateTime @default(now())

  @@unique([shopId, serviceName, category])
  @@index([shopId])
  @@map("shop_services")
}

// Labor rates for shops
model ShopLaborRate {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name     String
  rate     Float
  category String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId])
  @@map("shop_labor_rates")
}

// Tech/Manager Users
model Tech {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  email     String  @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      String // tech, manager

  available Boolean @default(true)

  // Labor rate for payroll
  hourlyRate Float @default(0)

  // Location tracking
  latitude           Float?
  longitude          Float?
  locationAccuracy   Float?
  lastLocationUpdate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignedWorkOrders WorkOrder[]
  statusHistory      StatusHistory[]
  timeEntries        TimeEntry[]

  @@index([shopId])
  @@map("techs")
}

// Vehicle model
model Vehicle {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  vehicleType  String // semi-truck, trailer, equipment, personal-vehicle
  make         String?
  model        String?
  year         Int?
  vin          String?
  licensePlate String?

  createdAt DateTime @default(now())

  workOrders   WorkOrder[]
  appointments Appointment[]

  @@index([customerId])
  @@map("vehicles")
}

// Work Order model
model WorkOrder {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id])

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])

  vehicleType     String
  serviceLocation String // roadside, in-shop

  // Services requested
  repairs     String? // RepairService[]
  maintenance String? // MaintenanceService[]

  // Parts
  partsMaterials String? // PartsMaterials

  // Issue description
  issueDescription String
  pictures         String? // string[]
  vinPhoto         String?

  // Location
  location String? // VehicleLocation

  // Assignment
  assignedTechId String?
  assignedTo     Tech?   @relation(fields: [assignedTechId], references: [id])
  bay            Int?    // Bay number (1-999) where work is being performed

  // Status
  status String @default("pending") // pending, assigned, in-progress, waiting-estimate, waiting-for-payment, closed, denied-estimate

  // Estimate
  estimate String? // Estimate with line items

  // Work details
  techLabor  String? // TechnicianLabor
  partsUsed  String? // PartLaborBreakdown
  workPhotos String? // WorkPhoto[]

  // Completion
  completion String? // CompletionVerification

  // Payment
  paymentStatus   String    @default("unpaid") // unpaid, pending, paid, refunded
  paymentIntentId String?
  amountPaid      Float?
  estimatedCost   Float? // Total cost estimate for the work order
  dueDate         DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  reviews          Review[]
  messages         Message[]
  statusHistory    StatusHistory[]
  customerMessages CustomerMessage[]
  tracking         TechTracking?
  purchaseOrderItems PurchaseOrderItem[]
  timeEntries      TimeEntry[]

  @@index([customerId])
  @@index([shopId])
  @@index([assignedTechId])
  @@index([status])
  @@map("work_orders")
}

// Status History
model StatusHistory {
  id          String    @id @default(cuid())
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  fromStatus String
  toStatus   String
  reason     String?

  changedById String?
  changedBy   Tech?   @relation(fields: [changedById], references: [id])

  createdAt DateTime @default(now())

  @@index([workOrderId])
  @@map("status_history")
}

// Messages
model Message {
  id          String    @id @default(cuid())
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  sender     String // customer, tech, manager
  senderName String
  body       String

  createdAt DateTime @default(now())

  @@index([workOrderId])
  @@map("messages")
}

// Notifications
model Notification {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type    String // status_update, estimate_ready, payment_due, appointment_reminder, etc.
  title   String
  message String
  read    Boolean   @default(false)
  readAt  DateTime?

  // Related entities
  workOrderId   String?
  appointmentId String?

  // Delivery methods
  deliveryMethod String // 'email,sms,push,in-app' (comma-separated)

  // Metadata
  metadata String? // JSON string for additional data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([read])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

// Inventory
model InventoryItem {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  type String // part, labor
  name String
  sku  String?

  // For parts
  quantity     Int   @default(0)
  price        Float @default(0)
  reorderPoint Int?

  // For labor
  rate Float? // hourly rate

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId])
  @@map("inventory")
}

// Payment Methods
model PaymentMethod {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type        String // card, bank
  last4       String
  brand       String?
  expiryMonth Int?
  expiryYear  Int?

  isDefault Boolean @default(false)

  stripePaymentMethodId String?

  createdAt DateTime @default(now())

  @@index([customerId])
  @@map("payment_methods")
}

// Reviews
// Removed duplicate - using enhanced Review model at end of file

// Activity Logs
model ActivityLog {
  id String @id @default(cuid())

  type     String // shop, revenue, user, alert
  action   String
  details  String
  location String?
  email    String?
  amount   String?
  severity String // info, success, warning, error
  user     String

  metadata String?

  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt])
  @@map("activity_logs")
}

// Admin model
model Admin {
  id       String @id @default(cuid())
  username String @unique
  password String
  email    String @unique

  isSuperAdmin Boolean @default(false)

  createdAt DateTime @default(now())

  refreshTokens RefreshToken[]

  @@map("admins")
}

// Refresh tokens for long-lived sessions
model RefreshToken {
  id        String   @id @default(cuid())
  tokenHash String
  adminId   String?
  createdAt DateTime @default(now())
  expiresAt DateTime
  metadata  String?

  admin Admin? @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Time tracking for employees (techs and managers)
model TimeEntry {
  id     String @id @default(cuid())
  techId String
  tech   Tech   @relation(fields: [techId], references: [id], onDelete: Cascade)
  shopId String

  clockIn  DateTime
  clockOut DateTime?

  // Break tracking (backwards-compatible single break fields kept for older code)
  breakStart    DateTime?
  breakEnd      DateTime?
  breakDuration Float? // Minutes

  // Support multiple breaks and historical break records
  breaks Json?        // [{ start: string, end?: string, durationMinutes?: number, type?: 'break'|'pto' }]

  // Link a time entry to a Work Order (optional)
  workOrderId String?
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])

  // PTO / manual entries
  isPto Boolean @default(false)

  // Approval & locking workflow
  approved   Boolean  @default(false)
  approvedBy String?
  approvedAt DateTime?
  locked     Boolean  @default(false)

  // Calculated fields
  hoursWorked Float? // Calculated when clocked out (excluding breaks)
  notes       String?

  // Location tracking (optional)
  location String?

  // Photo verification (optional - stored as URLs)
  clockInPhoto  String?
  clockOutPhoto String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([techId])
  @@index([shopId])
  @@index([clockIn])
  @@index([workOrderId])
  @@map("time_entries")
}

// Shop-specific settings for labor rates, margins, etc.
model ShopSettings {
  id     String @id @default(cuid())
  shopId String @unique
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Labor settings
  defaultLaborRate   Float @default(0) // Default hourly rate for labor
  overtimeMultiplier Float @default(1.5) // Overtime pay multiplier (1.5x standard)

  // Inventory markup (profit margin for parts)
  inventoryMarkup Float @default(0.30) // 30% markup on parts cost

  // Business hours
  businessHours String? // { monday: { open: '08:00', close: '17:00' }, ... }

  // Other settings
  taxRate           Float   @default(0)
  allowTimeTracking Boolean @default(true)
  requireClockInOut Boolean @default(false)

  // GPS verification settings
  gpsVerificationEnabled Boolean @default(false)
  shopLatitude           Float?
  shopLongitude          Float?
  gpsRadiusMeters        Int?    @default(100) // Allow clock in within 100m

  // Payroll budgets
  weeklyPayrollBudget  Float?
  monthlyPayrollBudget Float?

  // Shop-wide notification preferences
  notificationsEnabled      Boolean @default(true)
  notificationSoundEnabled  Boolean @default(true)
  notificationPreferences   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shop_settings")
}

// Inventory requests from managers
model InventoryRequest {
  id            String @id @default(cuid())
  shopId        String
  requestedById String // Tech ID (manager)

  itemName String
  quantity Int
  reason   String?
  urgency  String  @default("normal") // low, normal, high, urgent
  status   String  @default("pending") // pending, approved, ordered, received, denied

  approvedBy String?
  approvedAt DateTime?

  // Link to actual inventory item if approved
  inventoryItemId String?

  orderDetails String? // Purchase order info, tracking, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId])
  @@index([requestedById])
  @@index([status])
  @@map("inventory_requests")
}

// Full inventory management (created when inventory requests are approved or manually added)
model InventoryStock {
  id     String @id @default(cuid())
  shopId String

  itemName String
  sku      String?
  category String? // parts, fluids, tires, tools, etc.

  quantity        Int   @default(0)
  unitCost        Float @default(0)
  sellingPrice    Float @default(0)
  reorderPoint    Int   @default(10)
  reorderQuantity Int   @default(50)

  supplier    String?
  supplierSKU String?
  location    String? // shelf/bin location in shop

  // Tracking
  lastRestocked DateTime?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrderItems PurchaseOrderItem[]

  @@index([shopId])
  @@index([category])
  @@index([quantity]) // For low stock alerts
  @@map("inventory_stock")
}

model PurchaseOrder {
  id          String   @id @default(cuid())
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  vendor      String?
  status      String   @default("ordered") // ordered, shipped, received, cancelled
  expectedDate DateTime?
  notes       String?
  createdById String?
  totalCost   Float?

  items      PurchaseOrderItem[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([shopId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String         @id @default(cuid())
  purchaseOrderId  String
  purchaseOrder    PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  workOrderId      String?
  workOrder        WorkOrder?     @relation(fields: [workOrderId], references: [id])

  inventoryStockId String?
  inventoryStock   InventoryStock? @relation(fields: [inventoryStockId], references: [id])

  itemName String
  sku      String?
  quantity Int
  unitCost Float   @default(0)
  status   String  @default("ordered") // ordered, shipped, received, cancelled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([purchaseOrderId])
  @@index([workOrderId])
  @@index([inventoryStockId])
  @@map("purchase_order_items")
}

// Audit Log for admin actions
model AuditLog {
  id         String  @id @default(cuid())
  adminId    String
  action     String // user_updated, user_deleted, shop_approved, etc.
  targetId   String? // ID of affected resource
  targetType String? // user, shop, workorder, etc.
  details    String? // Additional context
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Direct Messages (Manager ↔ Tech, Manager ↔ Admin, Manager ↔ Customer)
model DirectMessage {
  id String @id @default(cuid())

  // Sender
  senderId   String
  senderRole String // manager, tech, admin, customer, shop
  senderName String

  // Receiver
  receiverId   String
  receiverRole String // manager, tech, admin, customer, shop
  receiverName String

  // Shop context (for managers/techs)
  shopId String?

  // Message content
  subject String?
  body    String

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Reply thread
  threadId String? // ID of the first message in conversation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId, senderRole])
  @@index([receiverId, receiverRole])
  @@index([shopId])
  @@index([threadId])
  @@index([createdAt])
  @@map("direct_messages")
}

// Appointments - Customer booking system
model Appointment {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  scheduledDate DateTime
  serviceType   String // oil-change, inspection, repair, etc.
  notes         String?
  status        String   @default("scheduled") // scheduled, confirmed, completed, cancelled, no-show

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages CustomerMessage[]

  @@index([customerId])
  @@index([shopId])
  @@index([scheduledDate])
  @@index([status])
  @@map("appointments")
}

// Reviews - Customer feedback system
model Review {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  rating  Int // 1-5 stars
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workOrderId, customerId])
  @@index([customerId])
  @@index([shopId])
  @@index([rating])
  @@map("reviews")
}

// Favorite Shops - Customer saved shops
model FavoriteShop {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  shopId String

  createdAt DateTime @default(now())

  @@unique([customerId, shopId])
  @@index([customerId])
  @@map("favorite_shops")
}

// Customer Documents - Invoices, receipts, warranties
model CustomerDocument {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name     String
  type     String @default("other") // invoice, receipt, warranty, contract, other
  url      String // Cloudinary URL
  fileSize Int    @default(0)

  workOrderId String?

  uploadedAt DateTime @default(now())

  @@index([customerId])
  @@index([workOrderId])
  @@map("customer_documents")
}

// Customer Messages - Chat between customer and tech
model CustomerMessage {
  id          String    @id @default(cuid())
  customerId  String
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // Can be linked to workOrder OR appointment (at least one required)
  workOrderId   String?
  workOrder     WorkOrder?   @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  from    String // 'customer' or 'tech' or 'shop'
  content String
  read    Boolean @default(false)

  sentAt DateTime @default(now())

  @@index([customerId])
  @@index([workOrderId])
  @@index([appointmentId])
  @@index([read])
  @@map("customer_messages")
}

// Tech Tracking - Real-time GPS location for active work orders
model TechTracking {
  id          String    @id @default(cuid())
  workOrderId String    @unique
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  latitude         Float
  longitude        Float
  estimatedArrival DateTime?

  updatedAt DateTime @updatedAt

  @@index([workOrderId])
  @@map("tech_tracking")
}

// Push Subscriptions - Web push notifications
model PushSubscription {
  id           String @id @default(cuid())
  customerId   String @unique
  subscription String // JSON string of push subscription

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@map("push_subscriptions")
}

// Subscription Management
model Subscription {
  id     String @id @default(cuid())
  shopId String @unique
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  plan                 String
  status               String  @default("active")
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  trialStart DateTime?
  trialEnd   DateTime?

  lastPaymentDate   DateTime?
  lastPaymentAmount Float?

  maxUsers Int @default(1)
  maxShops Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model PaymentHistory {
  id                    String    @id @default(cuid())
  subscriptionId        String?
  stripeInvoiceId       String?   @unique
  stripeSubscriptionId  String?
  stripePaymentIntentId String?
  amount                Float
  currency              String    @default("usd")
  status                String
  description           String?
  receiptUrl            String?
  paidAt                DateTime?
  createdAt             DateTime  @default(now())

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@map("payment_history")
}

// Analytics tracking for website visits
model PageView {
  id        String   @id @default(cuid())
  path      String
  userAgent String?
  ipHash    String?  // Hashed IP for privacy
  sessionId String?
  referrer  String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([path])
  @@map("page_views")
}
